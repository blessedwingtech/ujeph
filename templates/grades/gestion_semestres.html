<!-- templates/grades/gestion_semestres.html -->
{% extends 'base.html' %}
{% block title %}Gestion des Semestres{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- En-t√™te -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3><i class="bi bi-calendar-range"></i> Gestion des Semestres</h3>
            <p class="text-muted">G√©rer les passages de semestre et les promotions acad√©miques</p>
        </div>
        <div>
            <span class="badge bg-primary fs-6">
                Ann√©e: {{ annee_courante }}
            </span>
        </div>
    </div>

    
    <!-- Cartes d'information -->
    <div class="row mb-4">
        <!-- √âtudiants en S1 -->
        <div class="col-md-4">
            <div class="card border-start border-info border-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-info">Semestre 1</h5>
                            <p class="card-text text-muted mb-1">√âtudiants actuellement en S1</p>
                        </div>
                        <div class="display-5 text-info">
                            {{ stats.s1 }}
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Ces √©tudiants suivent les cours du premier semestre
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- √âtudiants en S2 -->
        <div class="col-md-4">
            <div class="card border-start border-warning border-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-warning">Semestre 2</h5>
                            <p class="card-text text-muted mb-1">√âtudiants actuellement en S2</p>
                        </div>
                        <div class="display-5 text-warning">
                            {{ stats.s2 }}
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Ces √©tudiants suivent les cours du second semestre
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiques g√©n√©rales -->
        <div class="col-md-4">
            <div class="card border-start border-success border-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title text-success">Total Actifs</h5>
                            <p class="card-text text-muted mb-1">√âtudiants actifs</p>
                        </div>
                        <div class="display-5 text-success">
                            {{ stats.total }}
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Tous les √©tudiants en statut "actif"
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions principales -->
    <div class="row">
        <!-- Passage S1 ‚Üí S2 -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-arrow-right-circle"></i> Passage Semestre 1 ‚Üí 2
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Attention : Action irr√©versible</strong>
                        <p class="mb-0 small">
                            Tous les √©tudiants en <strong>S1</strong> passeront en <strong>S2</strong>.
                            Les cours seront automatiquement r√©attribu√©s.
                        </p>
                    </div>

                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Changement de semestre : S1 ‚Üí S2
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            M√™me niveau acad√©mique
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            R√©attribution automatique des cours S2
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Pas de promotion de niveau
                        </li>
                    </ul>

                    <form method="post">
                        {% csrf_token %}
                        <div class="d-grid gap-2">
                            <button type="submit" name="action" value="S1_to_S2"
                                    class="btn btn-info btn-lg" 
                                    onclick="return confirmS1toS2(event, {{ stats.s1 }})"> 
                                <i class="bi bi-arrow-right"></i> Appliquer S1 ‚Üí S2
                            </button>
                            <small class="text-muted text-center">
                                Affectera {{ stats.s1 }} √©tudiant{{ stats.s1|pluralize }}
                            </small>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Passage S2 ‚Üí S1 (Fin d'ann√©e) -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-arrow-up-circle"></i> Fin d'ann√©e : S2 ‚Üí S1
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Fin d'ann√©e acad√©mique - R√àGLE UJEPH</strong>
                        <p class="mb-0 small">
                            Les moyennes seront calcul√©es selon la r√®gle de l'UJEPH : <strong>70/100</strong>
                        </p>
                    </div>

                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item">
                            <i class="bi bi-calculator text-primary me-2"></i>
                            Calcul des moyennes S1 et S2
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-graph-up text-primary me-2"></i>
                            Calcul de la moyenne g√©n√©rale (S1 + S2) / 2
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-person-check text-success me-2"></i>
                            <strong>Promotion des admis</strong> : Moyenne g√©n√©rale ‚â• 70/100
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-arrow-repeat text-danger me-2"></i>
                            <strong>Redoublement</strong> : Moyenne g√©n√©rale < 70/100
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-book text-info me-2"></i>
                            R√©attribution automatique des cours S1
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-info-circle text-info me-2"></i>
                            <strong>Pas de passage conditionnel</strong> - R√®gle binaire UJEPH
                        </li>
                    </ul>

                    <form method="post">
                        {% csrf_token %}
                        <div class="d-grid gap-2">
                            <button type="submit" name="action" value="S2_to_S1"
                                    class="btn btn-warning btn-lg"
                                    onclick="return confirmS2toS1(event, {{ stats.s2 }})"> 
                                    <i class="bi bi-arrow-up"></i> Terminer l'ann√©e (S2 ‚Üí S1)
                            </button>
                            <small class="text-muted text-center">
                                Affectera {{ stats.s2 }} √©tudiant{{ stats.s2|pluralize }}
                            </small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
<!-- Template simplifi√© avec juste 1-2 liens -->
<div hidden class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h5><i class="bi bi-link-45deg"></i> Liens rapides</h5>
            <div class="d-flex flex-wrap gap-2 mt-2">
                <a href="{% url 'grades:gestion_releves_complete' %}" class="btn btn-outline-warning btn-sm">
                    <i class="bi bi-file-earmark-text"></i> Gestion des relev√©s compl√®tes
                </a>
                <a href="{% url 'grades:gestion_releves' %}" class="btn btn-outline-info btn-sm">
                    <i class="bi bi-file-earmark-text"></i> Gestion des relev√©s
                </a>
                <a href="{% url 'grades:generer_releves' %}" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-plus-circle"></i> G√©n√©rer des relev√©s
                </a>
                {% if request.user.role == 'student' %}
                <a href="{% url 'grades:mes_releves' %}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-person-circle"></i> Mes relev√©s
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>    

    <!-- Historique r√©cent -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-clock-history"></i> Historique r√©cent des changements
            </h5>
        </div>
        <div class="card-body">
            {% if historique_recent %}
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>√âtudiant</th>
                            <th>Changement</th>
                            <th>D√©cision</th>
                            <th>Moyenne</th>
                            <th>Effectu√© par</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for hist in historique_recent %}
                        <tr>
                            <td>{{ hist.date_promotion|date:"d/m/Y H:i" }}</td>
                            <td>
                                <strong>{{ hist.etudiant.matricule }}</strong><br>
                                <small>{{ hist.etudiant.user.get_full_name|truncatechars:20 }}</small>
                            </td>
                            <td>
                                <span class="badge bg-secondary">
                                    {{ hist.ancien_niveau }}{{ hist.ancien_semestre }}
                                </span>
                                <i class="bi bi-arrow-right mx-1"></i>
                                <span class="badge {% if hist.nouveau_semestre == 'S1' %}bg-info{% else %}bg-warning{% endif %}">
                                    {{ hist.nouveau_niveau }}{{ hist.nouveau_semestre }}
                                </span>
                            </td>
                            <td>
                                {% if hist.decision == 'admis' %}
                                <span class="badge bg-success">Admis</span>
                                {% elif hist.decision == 'redouble' %}
                                <span class="badge bg-danger">Redouble</span>
                                {% elif hist.decision == 'passage_conditionnel' %}
                                <span class="badge bg-warning">Passage cond.</span>
                                {% elif hist.decision == 'diplome' %}
                                <span class="badge bg-primary">Dipl√¥m√©</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ hist.decision }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if hist.moyenne_generale %}
                                <span class="badge 
                                    {% if hist.moyenne_generale >= 70 %}bg-success
                                    {% else %}bg-danger{% endif %}">
                                    {{ hist.moyenne_generale|floatformat:2 }}/100
                                </span>
                                {% else %}
                                <span class="text-muted">--</span>
                                {% endif %}
                            </td>
                            <td>{{ hist.effectue_par.get_full_name|default:"Syst√®me" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-clock-history display-4 text-muted"></i>
                <p class="text-muted mt-2">Aucun historique disponible</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Notes importantes -->
    <div class="alert alert-secondary mt-4">
        <h6><i class="bi bi-info-circle"></i> Notes importantes :</h6>
        <ul class="mb-0">
            <li>Ces actions affectent <strong>tous les √©tudiants actifs</strong> du semestre concern√©</li>
            <li>Les <strong>cours sont automatiquement r√©attribu√©s</strong> selon le nouveau semestre/niveau</li>
            <li>Les <strong>moyennes sont recalcul√©es</strong> avant les d√©cisions de promotion</li>
            <li>Un <strong>historique d√©taill√©</strong> est conserv√© pour chaque changement</li>
            <li><strong>R√®gle UJEPH</strong> : Promotion si moyenne g√©n√©rale ‚â• 70/100, redoublement sinon</li>
            <li>Ces actions affectent <strong>tous les √©tudiants actifs</strong> du semestre concern√© selon la <strong>r√®gle UJEPH (70/100)</strong></li>
            <li>Ces actions sont <strong>irr√©versibles</strong> - faites des sauvegardes si n√©cessaire</li>
        </ul>
    </div>
</div>

<!-- JavaScript pour les confirmations -->
<script>
// Fonction pour S1 ‚Üí S2
// Fonction pour S1 ‚Üí S2 - VERSION AVEC D√âBOGAGE
function confirmS1toS2(event, count) {
    console.log('üîç D√©but confirmS1toS2, count:', count);
    console.log('üîç Event target:', event.target);
    console.log('üîç Bouton cliqu√©:', event.target.tagName, event.target.className);
    
    // Bloquer la soumission normale
    event.preventDefault();
    
    Swal.fire({
        title: '‚ö†Ô∏è Passage S1 ‚Üí S2',
        html: `
            <div class="text-start">
                <p><strong>Nombre d'√©tudiants concern√©s :</strong> ${count}</p>
                <p><strong>Actions :</strong></p>
                <ul>
                    <li>Changement de semestre : S1 ‚Üí S2</li>
                    <li>M√™me niveau acad√©mique</li>
                    <li>R√©attribution automatique des cours S2</li>
                </ul>
                <p class="text-danger mt-3"><i class="bi bi-exclamation-triangle"></i> Action irr√©versible</p>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Confirmer',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#0dcaf0',
        cancelButtonColor: '#6c757d',
        allowOutsideClick: false,
        allowEscapeKey: false
    }).then((result) => {
        console.log('üîç R√©sultat SweetAlert:', result);
        
        if (result.isConfirmed) {
            console.log('‚úÖ Confirmation re√ßue, soumission du formulaire...');
            
            // OPTION 1: Chercher le formulaire parent
            const button = event.target;
            let form = button.closest('form');
            
            // OPTION 2: Si option 1 √©choue, chercher par s√©lecteur
            if (!form) {
                console.log('‚ö†Ô∏è Formulaire non trouv√© avec closest(), recherche alternative...');
                form = document.querySelector('form[action*="gestion-semestres"]');
            }
            
            // OPTION 3: Si toujours pas trouv√©, chercher n'importe quel formulaire dans la carte
            if (!form) {
                const card = button.closest('.card');
                if (card) {
                    form = card.querySelector('form');
                }
            }
            
            if (form) {
                console.log('‚úÖ Formulaire trouv√©:', form);
                console.log('‚úÖ Action du formulaire:', form.action);
                console.log('‚úÖ M√©thode du formulaire:', form.method);
                
                // Ajouter un champ cach√© pour l'action si n√©cessaire
                const actionInput = form.querySelector('input[name="action"]');
                if (!actionInput) {
                    console.log('‚ÑπÔ∏è Ajout champ action manquant');
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'action';
                    hiddenInput.value = 'S1_to_S2';
                    form.appendChild(hiddenInput);
                }
                
                // Soumettre
                form.submit();
                console.log('üöÄ Formulaire soumis !');
            } else {
                console.error('‚ùå ERREUR: Formulaire non trouv√© !');
                Swal.fire({
                    title: 'Erreur',
                    text: 'Impossible de trouver le formulaire √† soumettre',
                    icon: 'error'
                });
            }
        } else {
            console.log('‚ùå Annul√© par l\'utilisateur');
        }
    }).catch((error) => {
        console.error('‚ùå Erreur SweetAlert:', error);
    });
    
    return false;
}
// Fonction pour S2 ‚Üí S1 (Fin d'ann√©e UJEPH)
// Fonction pour S2 ‚Üí S1 (Fin d'ann√©e UJEPH) - VERSION CORRIG√âE
function confirmS2toS1(event, count) {
    console.log('üîç D√©but confirmS2toS1, count:', count);
    console.log('üîç Event target:', event.target);
    console.log('üîç Bouton cliqu√©:', event.target.tagName, event.target.className);
    
    // Bloquer la soumission normale
    event.preventDefault();
    
    Swal.fire({
        title: 'üö® Fin d\'ann√©e acad√©mique',
        html: `
            <div class="text-start">
                <p><strong>R√àGLE UJEPH : 70/100</strong></p>
                <p><strong>Nombre d'√©tudiants concern√©s :</strong> ${count}</p>
                
                <p><strong>Pour chaque √©tudiant en S2 :</strong></p>
                <ul>
                    <li>üìä Calcul moyenne S1 (si disponible)</li>
                    <li>üìä Calcul moyenne S2</li>
                    <li>üéØ Moyenne g√©n√©rale = (S1 + S2) / 2</li>
                </ul>
                
                <p><strong>D√©cision :</strong></p>
                <ul>
                    <li><span class="text-success">‚úì Admis</span> : Moyenne ‚â• 70 ‚Üí Niveau suivant</li>
                    <li><span class="text-danger">‚úó Redouble</span> : Moyenne < 70 ‚Üí M√™me niveau</li>
                </ul>
                
                <p><strong>Pour tous :</strong></p>
                <ul>
                    <li>üîÑ S2 ‚Üí S1</li>
                    <li>üìö Cours S1 r√©attribu√©s automatiquement</li>
                </ul>
                
                <p class="text-danger mt-3"><i class="bi bi-exclamation-triangle-fill"></i> Action critique et irr√©versible</p>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Appliquer les d√©cisions',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        width: '600px',
        allowOutsideClick: false,
        allowEscapeKey: false
    }).then((result) => {
        console.log('üîç R√©sultat SweetAlert:', result);
        
        if (result.isConfirmed) {
            console.log('‚úÖ Confirmation re√ßue, soumission du formulaire...');
            
            // OPTION 1: Chercher le formulaire parent
            const button = event.target;
            let form = button.closest('form');
            
            // OPTION 2: Si option 1 √©choue, chercher par s√©lecteur
            if (!form) {
                console.log('‚ö†Ô∏è Formulaire non trouv√© avec closest(), recherche alternative...');
                form = document.querySelector('form[action*="gestion-semestres"]');
            }
            
            // OPTION 3: Si toujours pas trouv√©, chercher n'importe quel formulaire dans la carte
            if (!form) {
                const card = button.closest('.card');
                if (card) {
                    form = card.querySelector('form');
                }
            }
            
            if (form) {
                console.log('‚úÖ Formulaire trouv√©:', form);
                console.log('‚úÖ Action du formulaire:', form.action);
                console.log('‚úÖ M√©thode du formulaire:', form.method);
                
                // Ajouter un champ cach√© pour l'action si n√©cessaire
                const actionInput = form.querySelector('input[name="action"]');
                if (!actionInput) {
                    console.log('‚ÑπÔ∏è Ajout champ action manquant');
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'action';
                    hiddenInput.value = 'S2_to_S1';
                    form.appendChild(hiddenInput);
                } else {
                    // S'assurer que la valeur est correcte
                    actionInput.value = 'S2_to_S1';
                }
                
                // Soumettre
                form.submit();
                console.log('üöÄ Formulaire soumis !');
                
                // Optionnel: Afficher un message de chargement
                Swal.fire({
                    title: 'Traitement en cours...',
                    text: 'Application des d√©cisions de fin d\'ann√©e',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
            } else {
                console.error('‚ùå ERREUR: Formulaire non trouv√© !');
                Swal.fire({
                    title: 'Erreur',
                    text: 'Impossible de trouver le formulaire √† soumettre',
                    icon: 'error',
                    confirmButtonColor: '#ffc107'
                });
            }
        } else {
            console.log('‚ùå Annul√© par l\'utilisateur');
        }
    }).catch((error) => {
        console.error('‚ùå Erreur SweetAlert:', error);
        Swal.fire({
            title: 'Erreur technique',
            text: 'Une erreur est survenue lors de la confirmation',
            icon: 'error'
        });
    });
    
    return false;
}

</script>

<!-- Styles CSS -->
<style>
.card {
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #dee2e6;
}

.card-header {
    font-weight: 600;
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.badge {
    font-weight: 500;
}

.alert ul {
    padding-left: 1.5rem;
}

.alert ul li {
    margin-bottom: 0.25rem;
}

.table td {
    vertical-align: middle;
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-weight: 600;
}
</style>
{% endblock %}