{% extends 'base.html' %}
{% block title %}Historique Complet - {{ etudiant.user.get_full_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- En-tête -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <i class="bi bi-clock-history"></i> 
                        Historique Académique Complet
                    </h4>
                    <small class="opacity-75">{{ etudiant.user.get_full_name }} - {{ etudiant.matricule }}</small>
                </div>
                <div>
                    <a href="{% url 'accounts:voir_profil_utilisateur' etudiant.user.id %}" 
                       class="btn btn-outline-light btn-sm">
                        <i class="bi bi-person"></i> Voir Profil
                    </a>
                    <a href="{% url 'grades:gestion_releves' %}" class="btn btn-light btn-sm">
                        <i class="bi bi-arrow-left"></i> Retour
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 text-center">
                    <div class="card bg-light">
                        <div class="card-body">
                            <div class="display-6 fw-bold text-primary">
                                {% with total_releves=releves.count %}
                                {{ total_releves }}
                                {% endwith %}
                            </div>
                            <small>Relevés archivés</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 text-center">
                    <div class="card bg-light">
                        <div class="card-body">
                            <div class="display-6 fw-bold text-success">
                                {% with latest=releves.first %}
                                {{ latest.moyenne_cumulee|default:latest.moyenne_semestre|floatformat:2 }}
                                {% endwith %}
                            </div>
                            <small>Dernière moyenne</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 text-center">
                    <div class="card bg-light">
                        <div class="card-body">
                            <div class="display-6 fw-bold text-info">
                                {{ historique.count }}
                            </div>
                            <small>Promotions/Changements</small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 text-center">
                    <div class="card bg-light">
                        <div class="card-body">
                            <div class="display-6 fw-bold text-warning">
                                {{ etudiant.niveau }}
                            </div>
                            <small>Niveau actuel</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Timeline -->
    <div class="row">
        <!-- Historique des relevés -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Historique des Relevés</h5>
                </div>
                <div class="card-body">
                    {% if releves %}
                    <div class="timeline">
                        {% for releve in releves %}
                        <div class="timeline-item {% cycle '' 'timeline-item-right' %}">
                            <div class="timeline-marker {% if releve.moyenne_semestre >= 70 %}bg-success{% else %}bg-danger{% endif %}"></div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h6>
                                        {{ releve.annee_academique }} - {{ releve.semestre }}
                                        <span class="badge {% if releve.semestre == 'S1' %}bg-info{% else %}bg-warning{% endif %} float-end">
                                            {{ releve.semestre }}
                                        </span>
                                    </h6>
                                    <small class="text-muted">
                                        {{ releve.date_creation|date:"d/m/Y" }}
                                        {% if releve.valide_par %}
                                        • Validé par {{ releve.valide_par.get_full_name }}
                                        {% endif %}
                                    </small>
                                </div>
                                <div class="timeline-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <ul class="list-unstyled small">
                                                <li><i class="bi bi-book"></i> <strong>{{ releve.details_notes.notes|length }}</strong> cours suivis</li>
                                                <li><i class="bi bi-check-circle text-success"></i> <strong>{{ releve.calculer_stats.cours_valides|default:0 }}</strong> cours validés</li>
                                                <li><i class="bi bi-building"></i> {{ releve.faculte.nom|default:"N/A" }}</li>
                                                <li><i class="bi bi-flag"></i> Niveau : {{ releve.niveau }}</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <div class="h3 {% if releve.moyenne_semestre >= 70 %}text-success{% else %}text-danger{% endif %}">
                                                {{ releve.moyenne_semestre|floatformat:2 }}
                                            </div>
                                            <small>Moyenne Semestre</small>
                                            {% if releve.moyenne_cumulee %}
                                            <div class="h5 text-info mt-2">
                                                {{ releve.moyenne_cumulee|floatformat:2 }}
                                                <small class="text-muted">(Cumulée)</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="timeline-footer">
                                    <a href="{% url 'grades:detail_releve' releve.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> Voir détails
                                    </a>
                                    <a href="{% url 'grades:exporter_releve_csv' releve.id %}" class="btn btn-sm btn-outline-success">
                                        <i class="bi bi-download"></i> Télécharger
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-file-earmark-x display-1 text-muted"></i>
                        <h5 class="mt-3">Aucun relevé disponible</h5>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Graphique d'évolution -->
            {% if evolution %}
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Évolution de la Moyenne</h5>
                </div>
                <div class="card-body">
                    <canvas id="evolutionChart" height="100"></canvas>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Historique des promotions -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="bi bi-arrow-right-circle"></i> Parcours Académique</h5>
                </div>
                <div class="card-body">
                    {% if historique %}
                    <div class="list-group">
                        {% for promo in historique %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">
                                    <i class="bi bi-{% if promo.decision == 'admis' %}check-circle text-success{% elif promo.decision == 'redouble' %}x-circle text-danger{% else %}arrow-right-circle text-info{% endif %}"></i>
                                    {{ promo.get_decision_display }}
                                </h6>
                                <small>{{ promo.annee_academique }}</small>
                            </div>
                            <p class="mb-1 small">
                                <strong>{{ promo.ancien_niveau }}{{ promo.ancien_semestre }}</strong>
                                <i class="bi bi-arrow-right"></i>
                                <strong>{{ promo.nouveau_niveau }}{{ promo.nouveau_semestre }}</strong>
                            </p>
                            {% if promo.moyenne_generale %}
                            <small class="text-muted">
                                Moyenne : {{ promo.moyenne_generale|floatformat:2 }}/100
                            </small>
                            {% endif %}
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> {{ promo.date_promotion|date:"d/m/Y" }}
                                    {% if promo.effectue_par %}
                                    • Par {{ promo.effectue_par.get_full_name }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-info-circle display-1 text-muted"></i>
                        <h6 class="mt-3">Aucun changement de niveau</h6>
                        <p class="text-muted small">L'étudiant est resté au même niveau</p>
                    </div>
                    {% endif %}
                    
                    <!-- Situation actuelle -->
                    <div class="card mt-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Situation Actuelle</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr><td><strong>Niveau :</strong></td><td>{{ etudiant.niveau }}</td></tr>
                                <tr><td><strong>Semestre :</strong></td><td>{{ etudiant.semestre_courant }}</td></tr>
                                <tr><td><strong>Statut :</strong></td><td>{{ etudiant.get_statut_academique_display }}</td></tr>
                                <tr><td><strong>Faculté :</strong></td><td>{{ etudiant.faculte.nom }}</td></tr>
                                <tr><td><strong>Moyenne Générale :</strong></td>
                                    <td class="{% if etudiant.moyenne_generale >= 70 %}text-success{% elif etudiant.moyenne_generale %}text-warning{% endif %}">
                                        {{ etudiant.moyenne_generale|default:"Non calculée"|floatformat:2 }}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export complet -->
    <div class="card mt-4">
        <div class="card-body text-center">
            <h5><i class="bi bi-download"></i> Exporter l'Historique Complet</h5>
            <div class="btn-group mt-2">
                <button class="btn btn-outline-primary" onclick="exportFullHistoryCSV()">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Format CSV
                </button>
                <button class="btn btn-outline-success" onclick="printFullHistory()">
                    <i class="bi bi-printer"></i> Imprimer l'historique
                </button>
                {% if request.user.role == 'admin' %}
                <a href="#" class="btn btn-outline-info">
                    <i class="bi bi-envelope"></i> Envoyer à l'étudiant
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if evolution %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function exportFullHistoryCSV() {
    let csv = 'Période,Moyenne,Niveau,Statut\n';
    
    {% for point in evolution %}
    csv += '{{ point.periode }},{{ point.moyenne }},{{ point.niveau }},{% if point.moyenne >= 70 %}Validé{% else %}Échoué{% endif %}\n';
    {% endfor %}
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'historique_{{ etudiant.matricule }}_{{ "now"|date:"Y-m-d" }}.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function printFullHistory() {
    window.print();
}

document.addEventListener('DOMContentLoaded', function() {
    // Graphique d'évolution
    const ctx = document.getElementById('evolutionChart').getContext('2d');
    const labels = [{% for point in evolution %}'{{ point.periode }}',{% endfor %}];
    const data = [{% for point in evolution %}{{ point.moyenne }},{% endfor %}];
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Moyenne',
                data: data,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Moyenne: ${context.parsed.y}/100`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Moyenne /100'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Période'
                    }
                }
            }
        }
    });
});
</script>
{% endif %}

<style>
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
    transform: translateX(-50%);
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
    width: 50%;
    clear: both;
}

.timeline-item-right {
    float: right;
}

.timeline-marker {
    position: absolute;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #6c757d;
    top: 15px;
    right: -8px;
    z-index: 1;
}

.timeline-item-right .timeline-marker {
    left: -8px;
    right: auto;
}

.timeline-content {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    margin: 0 20px;
}

.timeline-header {
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #dee2e6;
}

.timeline-body {
    margin-bottom: 10px;
}

.timeline-footer {
    padding-top: 10px;
    border-top: 1px solid #dee2e6;
}

@media (max-width: 768px) {
    .timeline::before {
        left: 30px;
    }
    .timeline-item, .timeline-item-right {
        width: 100%;
        float: none;
        margin-left: 60px;
    }
    .timeline-marker {
        left: 22px !important;
        right: auto !important;
    }
}

@media print {
    .btn, .btn-group, .navbar, .sidebar {
        display: none !important;
    }
    .card {
        border: 1px solid #000 !important;
        page-break-inside: avoid;
    }
    .card-header {
        background-color: #fff !important;
        color: #000 !important;
        border-bottom: 2px solid #000;
    }
    canvas {
        display: none !important;
    }
    .timeline::before {
        display: none;
    }
    .timeline-marker {
        display: none;
    }
    .timeline-item, .timeline-item-right {
        width: 100%;
        float: none;
        margin-left: 0;
    }
}
</style>
{% endblock %}