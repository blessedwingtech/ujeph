{% extends 'base.html' %}
{% block title %}Relevé du Cours - {{ cours.intitule }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- En-tête -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center {% if request.user.role == 'prof' %}bg-info text-white{% else %}bg-primary text-white{% endif %}">
            <div>
                <h4 class="mb-0">
                    <i class="bi bi-journal-text"></i> 
                    Relevé des Notes - {{ cours.intitule }}
                </h4>
                <small class="opacity-75">
                    {{ cours.code }} | {{ cours.faculte.nom }} | {{ cours.get_niveau_display }} | {{ cours.semestre }}
                </small>
            </div>
            <div class="btn-group">
                <a href="{% if request.user.role == 'prof' %}{% url 'academics:mes_cours_professeur' %}{% else %}{% url 'academics:liste_cours' %}{% endif %}" 
                   class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Retour
                </a>
                <button class="btn btn-light btn-sm" onclick="window.print()">
                    <i class="bi bi-printer"></i> Imprimer
                </button>
            </div>
        </div>
        
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6>Informations Cours</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Code :</strong></td><td>{{ cours.code }}</td></tr>
                        <tr><td><strong>Intitulé :</strong></td><td>{{ cours.intitule }}</td></tr>
                        <tr><td><strong>Faculté :</strong></td><td>{{ cours.faculte.nom }}</td></tr>
                        <tr><td><strong>Crédits :</strong></td><td>{{ cours.credits }}</td></tr>
                    </table>
                </div>
                
                <div class="col-md-4">
                    <h6>Informations Enseignement</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Professeur :</strong></td><td>{{ cours.professeur.get_full_name|default:"Non assigné" }}</td></tr>
                        <tr><td><strong>Niveau :</strong></td><td>{{ cours.get_niveau_display }}</td></tr>
                        <tr><td><strong>Semestre :</strong></td><td>{{ cours.get_semestre_display }}</td></tr>
                        <tr><td><strong>Date génération :</strong></td><td>{{ "now"|date:"d/m/Y H:i" }}</td></tr>
                    </table>
                </div>
                
                <div class="col-md-4">
                    <h6>Statistiques Globales</h6>
                    <div class="text-center">
                        <div class="display-6 fw-bold {% if stats.moyenne_cours >= 70 %}text-success{% elif stats.moyenne_cours >= 50 %}text-warning{% else %}text-danger{% endif %}">
                            {{ stats.moyenne_cours|floatformat:2 }}
                        </div>
                        <div class="text-muted">Moyenne du Cours</div>
                        <div class="mt-3">
                            <span class="badge bg-success">{{ stats.valides_70 }} validés</span>
                            <span class="badge bg-danger">{{ stats.echecs_70 }} échoués</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tableau des notes -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-table"></i> Liste des Étudiants et Notes</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Matricule</th>
                            <th>Nom & Prénom</th>
                            <th>Faculté</th>
                            <th>Note /100</th>
                            <th>Appréciation</th>
                            <th>Statut</th>
                            <th>Date Publication</th>
                            {% if request.user.role == 'admin' %}
                            <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for note in notes %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td><strong>{{ note.etudiant.matricule }}</strong></td>
                            <td>{{ note.etudiant.user.get_full_name }}</td>
                            <td>{{ note.etudiant.faculte.nom }}</td>
                            <td>
                                <span class="badge {% if note.valeur >= 70 %}bg-success{% elif note.valeur >= 50 %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                                    {{ note.valeur|floatformat:2 }}
                                </span>
                            </td>
                            <td>
                                {% if note.valeur >= 80 %}
                                <span class="text-success"><i class="bi bi-award"></i> Excellent</span>
                                {% elif note.valeur >= 70 %}
                                <span class="text-success"><i class="bi bi-check-circle"></i> Très Bien</span>
                                {% elif note.valeur >= 60 %}
                                <span class="text-info"><i class="bi bi-check"></i> Bien</span>
                                {% elif note.valeur >= 50 %}
                                <span class="text-warning"><i class="bi bi-dash-circle"></i> Passable</span>
                                {% else %}
                                <span class="text-danger"><i class="bi bi-x-circle"></i> Insuffisant</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge {% if note.valeur >= 70 %}bg-success{% else %}bg-danger{% endif %}">
                                    {% if note.valeur >= 70 %}Validé{% else %}Échoué{% endif %}
                                </span>
                            </td>
                            <td>{{ note.date_validation|date:"d/m/Y"|default:"-" }}</td>
                            {% if request.user.role == 'admin' %}
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'accounts:voir_profil_utilisateur' note.etudiant.user.id %}" 
                                       class="btn btn-outline-info" title="Voir profil">
                                        <i class="bi bi-person"></i>
                                    </a>
                                    <a href="#" class="btn btn-outline-warning" title="Modifier note">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{% if request.user.role == 'admin' %}9{% else %}8{% endif %}" class="text-center text-muted">
                                <i class="bi bi-exclamation-triangle"></i> 
                                Aucune note publiée pour ce cours
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% if notes %}
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="4"><strong>RÉCAPITULATIF</strong></td>
                            <td><strong>{{ stats.moyenne_cours|floatformat:2 }}</strong></td>
                            <td>
                                <span class="badge bg-success">{{ stats.valides_70 }} validés</span>
                                <span class="badge bg-danger">{{ stats.echecs_70 }} échoués</span>
                            </td>
                            <td colspan="{% if request.user.role == 'admin' %}3{% else %}2{% endif %}">
                                <small>Total étudiants : {{ stats.total_etudiants }}</small>
                            </td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
    
    <!-- Graphique de distribution -->
    {% if notes %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Distribution des Notes</h5>
                </div>
                <div class="card-body">
                    <canvas id="notesDistributionChart" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Taux de Réussite</h5>
                </div>
                <div class="card-body">
                    <canvas id="successRateChart" height="200"></canvas>
                    <div class="text-center mt-3">
                        <h2 class="{% if stats.valides_70 > stats.echecs_70 %}text-success{% else %}text-danger{% endif %}">
                            {{ stats.valides_70|floatformat:0 }}%
                        </h2>
                        <small>de réussite (≥70/100)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Export et Actions -->
    <div class="card">
        <div class="card-body text-center">
            <div class="btn-group" role="group">
                <a href="#" class="btn btn-outline-primary" onclick="exportToCSV()">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Exporter CSV
                </a>
                <a href="#" class="btn btn-outline-success" onclick="window.print()">
                    <i class="bi bi-printer"></i> Imprimer Relevé
                </a>
                {% if request.user.role == 'admin' or request.user == cours.professeur %}
                <a href="#" class="btn btn-outline-info">
                    <i class="bi bi-envelope"></i> Envoyer aux Étudiants
                </a>
                {% endif %}
                {% if request.user.role == 'admin' %}
                <a href="{% url 'grades:remettre_notes_brouillon' cours.id %}" class="btn btn-outline-warning">
                    <i class="bi bi-arrow-counterclockwise"></i> Remettre en Brouillon
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if notes %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function exportToCSV() {
    // Générer un CSV simple
    let csv = 'Matricule,Nom Prenom,Note,Statut\n';
    
    {% for note in notes %}
    csv += '{{ note.etudiant.matricule }},{{ note.etudiant.user.get_full_name }},{{ note.valeur }},{% if note.valeur >= 70 %}Validé{% else %}Échoué{% endif %}\n';
    {% endfor %}
    
    // Créer un blob et télécharger
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'releve_{{ cours.code }}_{{ "now"|date:"Y-m-d" }}.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

document.addEventListener('DOMContentLoaded', function() {
    // Distribution des notes
    const distributionCtx = document.getElementById('notesDistributionChart').getContext('2d');
    
    // Calculer les intervalles
    const intervals = {
        '90-100': 0,
        '80-89': 0,
        '70-79': 0,
        '60-69': 0,
        '50-59': 0,
        '0-49': 0
    };
    
    {% for note in notes %}
    const noteValue = {{ note.valeur }};
    if (noteValue >= 90) intervals['90-100']++;
    else if (noteValue >= 80) intervals['80-89']++;
    else if (noteValue >= 70) intervals['70-79']++;
    else if (noteValue >= 60) intervals['60-69']++;
    else if (noteValue >= 50) intervals['50-59']++;
    else intervals['0-49']++;
    {% endfor %}
    
    new Chart(distributionCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(intervals),
            datasets: [{
                label: 'Nombre d\'étudiants',
                data: Object.values(intervals),
                backgroundColor: [
                    '#198754', '#20c997', '#0dcaf0', 
                    '#6f42c1', '#fd7e14', '#dc3545'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Distribution par intervalles' }
            }
        }
    });
    
    // Taux de réussite
    const successCtx = document.getElementById('successRateChart').getContext('2d');
    const successRate = {{ stats.valides_70 }};
    const failureRate = {{ stats.echecs_70 }};
    
    new Chart(successCtx, {
        type: 'doughnut',
        data: {
            labels: ['Validés', 'Échoués'],
            datasets: [{
                data: [successRate, failureRate],
                backgroundColor: ['#198754', '#dc3545'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
});
</script>
{% endif %}

<style>
@media print {
    .btn, .btn-group, .navbar, .sidebar, .card-header.bg-primary,
    .card-header.bg-info, .card-header.bg-success {
        display: none !important;
    }
    .card {
        border: 1px solid #000 !important;
        page-break-inside: avoid;
    }
    .card-header {
        background-color: #fff !important;
        color: #000 !important;
        border-bottom: 2px solid #000;
    }
    canvas {
        display: none !important;
    }
}
</style>
{% endblock %}